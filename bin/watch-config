#!/bin/sh

while [[ -n $1 ]]; do
  case $1 in
    --)
        shift
        CMD=$@
        break
    ;;
  esac
  shift
done

if [ "x$CMD" = "x" ]; then
    echo "Usage: $0 -- COMMAND"
    exit 0
fi

VHOSTS=${VHOSTD}
STREAMS=${STREAMD}
EPAGES=${EPAGED}
REF_FILE=/tmp/config-check.ref

update_ref() {
    local file=$1
    local timestamp=`date +%Y%m%d%H%M.%S`

    touch "${file}" -t ${timestamp}
}

is_newer() {
    local dir=$1

    if [[ "$(find "${dir}" -newer "${REF_FILE}")" != "x" ]]; then
        echo "true"
    else
        echo "false"
    fi
}

while true; do
    sleep 10s
    if [[ ! -e "${REF_FILE}" || $(is_newer "${VHOSTS}") = "true" || $(is_newer "${STREAMS}") = "true" || $(is_newer "${EPAGES}") = "true" ]]; then
        update_ref "${REF_FILE}"
        eval "${CMD}"
    fi
done
